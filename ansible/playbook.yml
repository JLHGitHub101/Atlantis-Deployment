---
- name: Configure Atlantis Server
  hosts: atlantis
  become: yes
  vars:
    atlantis_version: "0.28.1"
    atlantis_port: 4141
    atlantis_user: "atlantis"
    atlantis_group: "atlantis"
    atlantis_data_dir: "/var/lib/atlantis"
    atlantis_config_dir: "/etc/atlantis"
    github_user: "{{ lookup('env', 'GITHUB_USER') }}"
    github_token: "{{ lookup('env', 'GITHUB_TOKEN') }}"
    github_webhook_secret: "{{ lookup('env', 'GITHUB_WEBHOOK_SECRET') }}"

  tasks:
    - name: Update system packages
      dnf:
        name: "*"
        state: latest
        update_cache: yes

    - name: Install required packages
      dnf:
        name:
          - wget
          - unzip
          - git
        state: present

    - name: Create atlantis system user
      user:
        name: "{{ atlantis_user }}"
        system: yes
        create_home: yes
        shell: /bin/bash
        state: present

    - name: Create atlantis directories
      file:
        path: "{{ item }}"
        state: directory
        owner: "{{ atlantis_user }}"
        group: "{{ atlantis_group }}"
        mode: '0755'
      loop:
        - "{{ atlantis_config_dir }}"
        - "{{ atlantis_data_dir }}"

    - name: Download Atlantis binary
      get_url:
        url: "https://github.com/runatlantis/atlantis/releases/download/v{{ atlantis_version }}/atlantis_linux_amd64.zip"
        dest: "/tmp/atlantis_linux_amd64.zip"
        mode: '0644'

    - name: Unzip Atlantis binary
      unarchive:
        src: "/tmp/atlantis_linux_amd64.zip"
        dest: "/tmp"
        remote_src: yes

    - name: Install Atlantis binary
      copy:
        src: "/tmp/atlantis"
        dest: "/usr/local/bin/atlantis"
        mode: '0755'
        remote_src: yes

    - name: Create Atlantis server config
      template:
        src: atlantis-config.yaml.j2
        dest: "{{ atlantis_config_dir }}/config.yaml"
        owner: "{{ atlantis_user }}"
        group: "{{ atlantis_group }}"
        mode: '0644'
      when: github_user != "" and github_token != ""

    - name: Create systemd service file
      template:
        src: atlantis.service.j2
        dest: /etc/systemd/system/atlantis.service
        mode: '0644'
      notify:
        - Reload systemd
        - Restart atlantis

    - name: Enable Atlantis service
      systemd:
        name: atlantis
        enabled: yes
      when: github_user != "" and github_token != "" and github_webhook_secret != ""

    - name: Start Atlantis service
      systemd:
        name: atlantis
        state: started
      when: github_user != "" and github_token != "" and github_webhook_secret != ""

  handlers:
    - name: Reload systemd
      systemd:
        daemon_reload: yes

    - name: Restart atlantis
      systemd:
        name: atlantis
        state: restarted
      when: github_user != "" and github_token != "" and github_webhook_secret != ""
