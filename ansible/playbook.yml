---
- name: Configure Atlantis via SSM
  hosts: atlantis
  gather_facts: false
  become: yes
  vars:
    atlantis_version: "0.38.0"
    atlantis_url: "https://atlantis.bytetrove.xyz"
    # AWS Secrets Manager secret ARN containing GitHub credentials
    secret_arn: "arn:aws:secretsmanager:us-west-2:778265708060:secret:atlantis/prod/config-k9SyAP"
    aws_region: "us-west-2"
  
  tasks:
    - name: Bootstrap Python
      raw: test -e /usr/bin/python3 || (apt -y update && apt install -y python3-minimal)
      changed_when: false

    - name: Verify we are running
      debug:
        msg: "Hello from the bootstrap process!"

    - name: Install Dependencies
      apt:
        name: 
          - unzip
          - git
          - curl
          - jq
          - awscli
          - gnupg
        state: present
        update_cache: yes

    # --- TERRAFORM INSTALLATION ---
    - name: Add HashiCorp GPG key
      shell: |
        wget -O- https://apt.releases.hashicorp.com/gpg | gpg --dearmor | tee /usr/share/keyrings/hashicorp-archive-keyring.gpg > /dev/null
      args:
        creates: /usr/share/keyrings/hashicorp-archive-keyring.gpg

    - name: Add HashiCorp Repo
      shell: |
        echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | tee /etc/apt/sources.list.d/hashicorp.list
      args:
        creates: /etc/apt/sources.list.d/hashicorp.list

    - name: Install Terraform
      apt:
        name: terraform
        state: present
        update_cache: yes

    # SSM is used for connection, SSH key fetch is not required.

    # --- ATLANTIS INSTALLATION ---
    - name: Install Atlantis Binary
      unarchive:
        src: "https://github.com/runatlantis/atlantis/releases/download/v{{ atlantis_version }}/atlantis_linux_amd64.zip"
        dest: /usr/local/bin/
        remote_src: yes
        mode: '0755'

    - name: Create Atlantis User
      user:
        name: atlantis
        shell: /bin/bash
        home: /home/atlantis
        groups: adm
        append: yes

    - name: Create Atlantis home directory
      file:
        path: /home/atlantis
        state: directory
        owner: atlantis
        group: atlantis
        mode: '0755'

    # THE MAGIC STEP: Create a wrapper script to fetch secrets from Secrets Manager
    - name: Create Atlantis Wrapper Script
      copy:
        dest: /usr/local/bin/start-atlantis.sh
        mode: '0755'
        content: |
          #!/bin/bash
          
          # Fetch JSON from AWS Secrets Manager
          SECRET_JSON=$(aws secretsmanager get-secret-value --secret-id {{ secret_arn }} --query SecretString --output text --region {{ aws_region }})
          
          # Parse secrets into Env Vars (adjust keys to match your secret JSON structure)
          GH_USER=$(echo $SECRET_JSON | jq -r '.atlantis_gh_user // .github_user // .gh_user')
          GH_TOKEN=$(echo $SECRET_JSON | jq -r '.atlantis_gh_token // .github_token // .gh_token')
          WH_SECRET=$(echo $SECRET_JSON | jq -r '.atlantis_gh_webhook_secret // .webhook_secret // .gh_webhook_secret')

          # Start Atlantis with credentials
          /usr/local/bin/atlantis server \
            --atlantis-url="{{ atlantis_url }}" \
            --gh-user="$GH_USER" \
            --gh-token="$GH_TOKEN" \
            --gh-webhook-secret="$WH_SECRET" \
            --repo-allowlist="github.com/JLHGitHub101/My-Lab" \
            --port=4141

    - name: Create Systemd Service
      copy:
        dest: /etc/systemd/system/atlantis.service
        content: |
          [Unit]
          Description=Atlantis
          After=network.target

          [Service]
          User=atlantis
          Group=atlantis
          # Run the wrapper script, not the binary directly
          ExecStart=/usr/local/bin/start-atlantis.sh
          Restart=always
          StandardOutput=journal
          StandardError=journal

          [Install]
          WantedBy=multi-user.target
      notify: Restart Atlantis

  handlers:
    - name: Restart Atlantis
      systemd: name=atlantis state=restarted enabled=yes daemon_reload=yes